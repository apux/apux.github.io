<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <title>El Blog de ApuX - Joins vs Includes</title>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
    <link href="/stylesheets/all.css" rel="stylesheet" type="text/css" />
  </head>
  <body>
    <div id="main" role="main">
      <nav>
  <ul>
    <li>
<a class="blog-title" href="/">        El Blog de Ap<span>uX</span>
</a>      <span class="caption">My Learning about Software Development</span>
    </li>
  </ul>
</nav>

      <section id="content">
          <article>
    <h1 class="heading">
      Joins vs Includes
      <time>Dec  8 2014</time>
    </h1>
    <p>Sometimes, <code>joins</code> and <code>includes</code> can be confusing because there are scenarios where they seem to be interchangeable, but there are specific reasons to use one or the other.</p>

<h2><code>joins</code></h2>

<p><code>joins</code> allow us to specify a relation to be included in the query. The resulting query will include a <code>JOIN</code> clause (SQL).</p>

<p>Let&rsquo;s say we have these two models: <code>Employee</code> that has one <code>Computer</code>.</p>
<pre class="highlight ruby"><code><span class="c1">#app/models/employee.rb</span>
<span class="k">class</span> <span class="nc">Employee</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_one</span> <span class="ss">:computer</span>
<span class="k">end</span>

<span class="c1">#app/models/computer.rb</span>
<span class="k">class</span> <span class="nc">Computer</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:employee</span>
<span class="k">end</span>
</code></pre>

<p>If we want to know all the employees whose name is &lsquo;Fernando&rsquo; and has a Dell computer, we can use <code>joins</code>.</p>
<pre class="highlight ruby"><code><span class="no">Employee</span><span class="p">.</span>
  <span class="nf">joins</span><span class="p">(</span><span class="ss">:computer</span><span class="p">).</span>
  <span class="nf">where</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Fernando'</span><span class="p">,</span> <span class="ss">computers: </span><span class="p">{</span> <span class="ss">brand: </span><span class="s1">'Dell'</span> <span class="p">})</span>
</code></pre>

<p>This query works well and returns all the employees who fulfill the conditions.</p>

<p>The SQL will be something like this:</p>
<pre class="highlight sql"><code><span class="k">SELECT</span> <span class="nv">"employees"</span><span class="p">.</span><span class="o">*</span>
 <span class="k">FROM</span> <span class="nv">"employees"</span>
 <span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">"computers"</span> <span class="k">ON</span> <span class="nv">"computers"</span><span class="p">.</span><span class="nv">"employee_id"</span> <span class="o">=</span> <span class="nv">"employees"</span><span class="p">.</span><span class="nv">"id"</span>
 <span class="k">WHERE</span> <span class="nv">"employees"</span><span class="p">.</span><span class="nv">"name"</span> <span class="o">=</span> <span class="s1">'Fernando'</span> <span class="k">AND</span> <span class="nv">"computers"</span><span class="p">.</span><span class="nv">"brand"</span> <span class="o">=</span> <span class="s1">'Dell'</span>

</code></pre>

<h2><code>includes</code></h2>

<p>As we explained in <a href="/2014/02/03/how-to-fix-n-1-queries-in-rails.html">a previous post</a>, if we want to load all the employees and all their computers in a single query, we can use <code>includes</code>, </p>
<pre class="highlight ruby"><code><span class="no">Employee</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:computer</span><span class="p">)</span>
</code></pre>

<p>This way, Rails hits the database just once, and load all the data from employees and computers. The confusion might start here, because using <code>includes</code> we can also perform some conditionals in the where clause. For, example:</p>
<pre class="highlight ruby"><code><span class="no">Employee</span><span class="p">.</span>
  <span class="nf">includes</span><span class="p">(</span><span class="ss">:computer</span><span class="p">).</span>
  <span class="nf">where</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Fernando'</span><span class="p">,</span> <span class="ss">computers: </span><span class="p">{</span> <span class="ss">brand: </span><span class="s1">'Dell'</span> <span class="p">})</span>
</code></pre>

<p>As we can see, it is possible to include conditionals that affect both relations, just like we did with <code>joins</code>.</p>

<p>However, the resulting SQL is different. Let&rsquo;s see:</p>
<pre class="highlight sql"><code><span class="k">SELECT</span> <span class="nv">"employees"</span><span class="p">.</span><span class="nv">"id"</span> <span class="k">AS</span> <span class="n">t0_r0</span><span class="p">,</span>
 <span class="nv">"employees"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">AS</span> <span class="n">t0_r1</span><span class="p">,</span>
 <span class="nv">"employees"</span><span class="p">.</span><span class="nv">"created_at"</span> <span class="k">AS</span> <span class="n">t0_r2</span><span class="p">,</span>
 <span class="nv">"employees"</span><span class="p">.</span><span class="nv">"updated_at"</span> <span class="k">AS</span> <span class="n">t0_r3</span><span class="p">,</span>
 <span class="nv">"computers"</span><span class="p">.</span><span class="nv">"id"</span> <span class="k">AS</span> <span class="n">t1_r0</span><span class="p">,</span>
 <span class="nv">"computers"</span><span class="p">.</span><span class="nv">"brand"</span> <span class="k">AS</span> <span class="n">t1_r1</span><span class="p">,</span>
 <span class="nv">"computers"</span><span class="p">.</span><span class="nv">"model"</span> <span class="k">AS</span> <span class="n">t1_r2</span><span class="p">,</span>
 <span class="nv">"computers"</span><span class="p">.</span><span class="nv">"employee_id"</span> <span class="k">AS</span> <span class="n">t1_r3</span><span class="p">,</span>
 <span class="nv">"computers"</span><span class="p">.</span><span class="nv">"created_at"</span> <span class="k">AS</span> <span class="n">t1_r4</span><span class="p">,</span>
 <span class="nv">"computers"</span><span class="p">.</span><span class="nv">"updated_at"</span> <span class="k">AS</span> <span class="n">t1_r5</span>
 <span class="k">FROM</span> <span class="nv">"employees"</span>
 <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="nv">"computers"</span> <span class="k">ON</span> <span class="nv">"computers"</span><span class="p">.</span><span class="nv">"employee_id"</span> <span class="o">=</span> <span class="nv">"employees"</span><span class="p">.</span><span class="nv">"id"</span>
 <span class="k">WHERE</span> <span class="nv">"employees"</span><span class="p">.</span><span class="nv">"name"</span> <span class="o">=</span> <span class="s1">'Fernando'</span> <span class="k">AND</span> <span class="nv">"computers"</span><span class="p">.</span><span class="nv">"brand"</span> <span class="o">=</span> <span class="s1">'Dell'</span>
</code></pre>

<p>As we can see, <code>includes</code> adds all the fields from computer, as expected, while <code>joins</code> doesn&rsquo;t. And this little difference is what we must take into account.</p>

<p>When we just want to filter the result of a query based on a field that belongs to a secondary relation, but we aren&rsquo;t going to use data of this relation later, we must use <code>joins</code>. Otherwise, we will load a lot of data that we are not going to use.</p>

<p>Example:</p>
<pre class="highlight ruby"><code><span class="n">employees</span> <span class="o">=</span> <span class="no">Employee</span><span class="p">.</span>
  <span class="nf">joins</span><span class="p">(</span><span class="ss">:computer</span><span class="p">).</span>
  <span class="nf">where</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Fernando'</span><span class="p">,</span> <span class="ss">computer: </span><span class="p">{</span> <span class="ss">brand: </span><span class="s1">'Dell'</span> <span class="p">})</span>
<span class="nb">puts</span> <span class="n">employees</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:name</span><span class="p">)</span>
</code></pre>

<p>On the other hand, if we need to use data from the secondary relation, then <code>includes</code> is mandatory, otherwise, we will have N+1 query issues.</p>

<p>Example:</p>
<pre class="highlight ruby"><code><span class="n">employees</span> <span class="o">=</span> <span class="no">Employee</span><span class="p">.</span>
  <span class="nf">joins</span><span class="p">(</span><span class="ss">:computer</span><span class="p">).</span>
  <span class="nf">where</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Fernando'</span><span class="p">,</span> <span class="ss">computer: </span><span class="p">{</span> <span class="ss">brand: </span><span class="s1">'Dell'</span> <span class="p">})</span>
<span class="nb">puts</span> <span class="n">employees</span><span class="p">.</span><span class="nf">map</span><span class="p">{</span><span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="s2">"</span><span class="si">#{</span><span class="n">e</span><span class="p">.</span><span class="nf">full_name</span><span class="si">}</span><span class="s2"> has a Dell </span><span class="si">#{</span><span class="n">e</span><span class="p">.</span><span class="nf">computer</span><span class="p">.</span><span class="nf">model</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span>
</code></pre>

<p>It is not so confusing after all, right?</p>

  </article>
  <div id="disqus_thread"></div>
<script type="text/javascript">
//<![CDATA[
                  var disqus_shortname = 'elblogdeapux';
          
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
//]]>
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


      </section>
      <footer>
  <div class="container">
    <ul class="large-column">
      <li><h5 class="heading">Recent Articles</h5></li>
      <li>
        <ol>
            <li>
              <a href="/2015/05/04/directory-tree.html">Directory tree</a>
              <span>May  4</span>
            </li>
            <li>
              <a href="/2015/04/13/directory-structure-conventions-in-rspec-and-minitest.html">Directory structure conventions in RSpec and Minitest</a>
              <span>Apr 13</span>
            </li>
            <li>
              <a href="/2015/01/12/joins-vs-includes-espanol.html">Joins vs Includes (Español)</a>
              <span>Jan 12</span>
            </li>
            <li>
              <a href="/2014/12/08/joins-vs-includes.html">Joins vs Includes</a>
              <span>Dec  8</span>
            </li>
            <li>
              <a href="/2014/09/01/minitest-v4-y-v5.html">Minitest v4 y  v5</a>
              <span>Sep  1</span>
            </li>
            <li>
              <a href="/2014/07/14/minitest-v4-and-v5.html">Minitest v4 and v5</a>
              <span>Jul 14</span>
            </li>
            <li>
              <a href="/2014/03/11/formularios-anidados.html">Formularios anidados</a>
              <span>Mar 11</span>
            </li>
            <li>
              <a href="/2014/02/10/como-solucionar-las-consultas-n-1-en-rails.html">Cómo solucionar consultas N+1 en Rails</a>
              <span>Feb 10</span>
            </li>
            <li>
              <a href="/2014/02/03/how-to-fix-n-1-queries-in-rails.html">How to fix N+1 queries in Rails</a>
              <span>Feb  3</span>
            </li>
            <li>
              <a href="/2014/01/13/super-in-ruby.html">Super in Ruby</a>
              <span>Jan 13</span>
            </li>
        </ol>
      </li>
    </ul>

    <ul class="small-column">
      <li><h5 class="heading">Tags</h5></li>
      <li>
        <ol>
            <li><a href="/tags/rails.html">Rails (8)</a></li>
            <li><a href="/tags/activerecord.html">ActiveRecord (7)</a></li>
            <li><a href="/tags/nested_attributes.html">nested_attributes (1)</a></li>
            <li><a href="/tags/formularios.html">formularios (1)</a></li>
            <li><a href="/tags/ruby.html">Ruby (5)</a></li>
            <li><a href="/tags/struct.html">Struct (1)</a></li>
            <li><a href="/tags/openstruct.html">OpenStruct (1)</a></li>
            <li><a href="/tags/asociaciones.html">Asociaciones (1)</a></li>
            <li><a href="/tags/minitest.html">Minitest (3)</a></li>
            <li><a href="/tags/rspec.html">RSpec (2)</a></li>
            <li><a href="/tags/tree.html">tree (1)</a></li>
        </ol>
      </li>
      <ul>
  </div>
</footer>

    </div>
  </body>
</html>
