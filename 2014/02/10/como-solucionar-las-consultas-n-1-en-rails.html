<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <title>El Blog de ApuX - Cómo solucionar consultas N+1 en Rails</title>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
    <link href="/stylesheets/all.css" rel="stylesheet" type="text/css" />
  </head>
  <body>
    <div id="main" role="main">
      <nav>
  <ul>
    <li>
<a class="blog-title" href="/">        El Blog de Ap<span>uX</span>
</a>      <span class="caption">My Learning about Software Development</span>
    </li>
  </ul>
</nav>

      <section id="content">
          <article>
    <h1 class="heading">
      Cómo solucionar consultas N+1 en Rails
      <time>Feb 10 2014</time>
    </h1>
    <p>Uno de los problemas de desempeño más comunes en Rails está relacionado con consultas N+1. Afortunadamente, nuestro framework incluye una solución simple para este problema que debemos conocer para evitarnos algunos dolores de cabeza.</p>

<p>Para aquellos que no lo sepan, el problema de consultas N+1 generamente aparece cuando tenemos dos o más modelos asociados, por ejemplo Empleado (<code>Employee</code>) que tiene una Computadora (<code>Computer</code>), y se quiere mostrar información sobre los empleados así como de sus computadoras. Esto provoca que rails ejecute una consulta para cargar a los empleados, y una consulta por cada computadora. Si la compañia tiene 10 empleados, se ejecutan 11 consultas.</p>

<p>Veamos un ejemplo:</p>
<pre class="highlight ruby"><code><span class="c1">#app/models/employee.rb</span>
<span class="k">class</span> <span class="nc">Employee</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_one</span> <span class="ss">:computer</span>
<span class="k">end</span>

<span class="c1">#app/models/computer.rb</span>
<span class="k">class</span> <span class="nc">Computer</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:employee</span>
<span class="k">end</span>
</code></pre>

<p>Queremos listar todos los empleados con sus computadoras.</p>
<pre class="highlight erb"><code><span class="nt">&lt;p&gt;</span>
  <span class="cp">&lt;%</span> <span class="n">employees</span> <span class="o">=</span> <span class="no">Employee</span><span class="p">.</span><span class="nf">all</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;ul&gt;</span>
    <span class="cp">&lt;%</span> <span class="n">employees</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">employee</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;li&gt;</span>
        <span class="nt">&lt;strong&gt;</span>Name:<span class="nt">&lt;/strong&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">employee</span><span class="p">.</span><span class="nf">name</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;strong&gt;</span>Computer<span class="nt">&lt;/strong&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">employee</span><span class="p">.</span><span class="nf">computer</span><span class="p">.</span><span class="nf">brand</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/li&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;/p&gt;</span>
</code></pre>

<p>Si revisamos los logs, nos encontramos este tipo de salidas:</p>
<pre class="highlight plaintext"><code>Employee Load (0.3ms)  SELECT "employees".* FROM "employees"
Computer Load (0.2ms)  SELECT "computers".* FROM "computers" WHERE "computers"."employee_id" = ? LIMIT 1  [["employee_id", 1]]
Computer Load (0.2ms)  SELECT "computers".* FROM "computers" WHERE "computers"."employee_id" = ? LIMIT 1  [["employee_id", 2]]
Computer Load (0.1ms)  SELECT "computers".* FROM "computers" WHERE "computers"."employee_id" = ? LIMIT 1  [["employee_id", 3]]
Computer Load (0.1ms)  SELECT "computers".* FROM "computers" WHERE "computers"."employee_id" = ? LIMIT 1  [["employee_id", 4]]
Computer Load (0.1ms)  SELECT "computers".* FROM "computers" WHERE "computers"."employee_id" = ? LIMIT 1  [["employee_id", 5]]
Computer Load (0.1ms)  SELECT "computers".* FROM "computers" WHERE "computers"."employee_id" = ? LIMIT 1  [["employee_id", 6]]
Computer Load (0.1ms)  SELECT "computers".* FROM "computers" WHERE "computers"."employee_id" = ? LIMIT 1  [["employee_id", 7]]
Computer Load (0.1ms)  SELECT "computers".* FROM "computers" WHERE "computers"."employee_id" = ? LIMIT 1  [["employee_id", 8]]
Computer Load (0.1ms)  SELECT "computers".* FROM "computers" WHERE "computers"."employee_id" = ? LIMIT 1  [["employee_id", 9]]
Computer Load (0.1ms)  SELECT "computers".* FROM "computers" WHERE "computers"."employee_id" = ? LIMIT 1  [["employee_id", 10]]
</code></pre>

<p>Esto indica que tenemos un problema N+1. Podemos solucionar este problema usando <em>eager loading</em>. En rails, esto puede hacerse usando <code>includes</code> para indicar que la consulta debe cargar no sólo los datos del empleado sino también los datos de sus computadoras.</p>
<pre class="highlight ruby"><code><span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="sx">% employees </span><span class="o">=</span> <span class="no">Employee</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:computer</span><span class="p">).</span><span class="nf">all</span> <span class="sx">%&gt;
  &lt;ul&gt;</span>
    <span class="o">&lt;</span><span class="sx">% employees.each </span><span class="k">do</span> <span class="o">|</span><span class="n">employee</span><span class="o">|</span> <span class="sx">%&gt;
      &lt;li&gt;</span>
        <span class="o">&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="no">Name</span><span class="ss">:&lt;</span><span class="o">/</span><span class="n">strong</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="sx">%= employee.name %&gt;
        &lt;strong&gt;Computer&lt;/strong&gt;
        &lt;%=</span> <span class="n">employee</span><span class="p">.</span><span class="nf">computer</span><span class="p">.</span><span class="nf">brand</span> <span class="sx">%&gt;
      &lt;/li&gt;</span>
    <span class="o">&lt;</span><span class="sx">% end </span><span class="o">%&gt;</span>
  <span class="o">&lt;</span><span class="sr">/ul&gt;
&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
</code></pre>

<p>Si revisamos los logs ahora, podemos ver que Rails realizó sólo una consulta:</p>
<pre class="highlight plaintext"><code>Computer Load (0.6ms)  SELECT "computers".* FROM "computers" WHERE "computers"."employee_id" IN (1, 2, 3, 4, 5, 6, 7, 8, 9, 10)
</code></pre>

<p>Se redujo el número de consultas a 1. Esto puede no parecer una gran mejora aquí, pero si la compañía tiene 1,000 empleados, se evita golpear 1,000 veces la base de datos cuando alguien visita esta página, y en ese caso, la diferencia sería importante.</p>

<p>Y sólo para aclarar, he usado este código como ejemplo por facilidad, pero no estoy recomendando realizar las consultas desde la vista. Hay que mover parte de este código a donde pertenece (controladores o modelos).</p>

  </article>
  <div id="disqus_thread"></div>
<script type="text/javascript">
//<![CDATA[
                  var disqus_shortname = 'elblogdeapux';
          
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
//]]>
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


      </section>
      <footer>
  <div class="container">
    <ul class="large-column">
      <li><h5 class="heading">Recent Articles</h5></li>
      <li>
        <ol>
            <li>
              <a href="/2015/08/31/how-to-install-postgresql-in-chakra-linux.html">How to Install Postgresql in Chakra Linux</a>
              <span>Aug 31</span>
            </li>
            <li>
              <a href="/2015/07/20/using-vim-regexp-to-update-to-rspec3-syntax.html">Using Vim Regexp to Update to RSpec 3 Syntax</a>
              <span>Jul 20</span>
            </li>
            <li>
              <a href="/2015/05/04/directory-tree.html">Directory tree</a>
              <span>May  4</span>
            </li>
            <li>
              <a href="/2015/04/13/directory-structure-conventions-in-rspec-and-minitest.html">Directory structure conventions in RSpec and Minitest</a>
              <span>Apr 13</span>
            </li>
            <li>
              <a href="/2015/01/12/joins-vs-includes-espanol.html">Joins vs Includes (Español)</a>
              <span>Jan 12</span>
            </li>
            <li>
              <a href="/2014/12/08/joins-vs-includes.html">Joins vs Includes</a>
              <span>Dec  8</span>
            </li>
            <li>
              <a href="/2014/09/01/minitest-v4-y-v5.html">Minitest v4 y  v5</a>
              <span>Sep  1</span>
            </li>
            <li>
              <a href="/2014/07/14/minitest-v4-and-v5.html">Minitest v4 and v5</a>
              <span>Jul 14</span>
            </li>
            <li>
              <a href="/2014/03/11/formularios-anidados.html">Formularios anidados</a>
              <span>Mar 11</span>
            </li>
            <li>
              <a href="/2014/02/10/como-solucionar-las-consultas-n-1-en-rails.html">Cómo solucionar consultas N+1 en Rails</a>
              <span>Feb 10</span>
            </li>
        </ol>
      </li>
    </ul>

    <ul class="small-column">
      <li><h5 class="heading">Tags</h5></li>
      <li>
        <ol>
            <li><a href="/tags/rails.html">Rails (8)</a></li>
            <li><a href="/tags/activerecord.html">ActiveRecord (7)</a></li>
            <li><a href="/tags/nested_attributes.html">nested_attributes (1)</a></li>
            <li><a href="/tags/formularios.html">formularios (1)</a></li>
            <li><a href="/tags/ruby.html">Ruby (5)</a></li>
            <li><a href="/tags/struct.html">Struct (1)</a></li>
            <li><a href="/tags/openstruct.html">OpenStruct (1)</a></li>
            <li><a href="/tags/asociaciones.html">Asociaciones (1)</a></li>
            <li><a href="/tags/minitest.html">Minitest (3)</a></li>
            <li><a href="/tags/postgresql.html">postgresql (1)</a></li>
            <li><a href="/tags/chakra.html">chakra (1)</a></li>
            <li><a href="/tags/vim.html">vim (1)</a></li>
            <li><a href="/tags/regexp.html">regexp (1)</a></li>
            <li><a href="/tags/rspec.html">rspec (1)</a></li>
            <li><a href="/tags/rspec.html">RSpec (2)</a></li>
            <li><a href="/tags/tree.html">tree (1)</a></li>
        </ol>
      </li>
      <ul>
  </div>
</footer>

    </div>
  </body>
</html>
