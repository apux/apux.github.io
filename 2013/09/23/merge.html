<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <title>El Blog de ApuX - Merge</title>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
    <link href="/stylesheets/all.css" rel="stylesheet" type="text/css" />
    <link href='//fonts.googleapis.com/css?family=Nunito:400,700,300' rel='stylesheet' type='text/css'>
    <link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Dancing Script:400,700" rel="stylesheet" type="text/css">
  </head>
  <body>
    <div id="main" role="main">
      <nav>
  <ul>
    <li>
<a class="blog-title" href="/">        El Blog de Ap<span>uX</span>
</a>      <span class="caption">My Learning about Software Development</span>
    </li>
  </ul>
</nav>

      <section id="content">
          <article>
    <h1 class="heading">
      Merge
      <time>Sep 23 2013</time>
    </h1>
    <p>Rails has a functionality that I use a lot but I think it is not as widespread
as it should.  I&rsquo;m talking about the <code>ActiveRecord</code>&rsquo;s <code>merge</code> method.  Probably,
the reason why this method is not widely used is because there is a method with
the same name in the <code>Hash</code> class and that causes some confusion.</p>

<h2><code>Hash</code>&rsquo;s <code>merge</code></h2>

<p>The <code>Hash</code>&rsquo;s <code>merge</code> method merges two hashes and returns a third hash. Example:</p>
<pre class="highlight ruby"><code><span class="n">h1</span> <span class="o">=</span> <span class="p">{</span><span class="ss">a: </span><span class="s1">'cat'</span><span class="p">,</span> <span class="ss">b: </span><span class="s1">'dog'</span><span class="p">}</span>
<span class="n">h2</span> <span class="o">=</span> <span class="p">{</span><span class="ss">c: </span><span class="s1">'bird'</span><span class="p">}</span>
<span class="n">h3</span> <span class="o">=</span> <span class="n">h1</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">h2</span><span class="p">)</span>
<span class="c1"># =&gt; {:a=&gt;"cat", :b=&gt;"dog", :c=&gt;"bird"}</span>
</code></pre>

<p>This is a method available on the
<a href="http://www.ruby-doc.org/core-2.0.0/Hash.html#method-i-merge">Ruby Core</a>.</p>

<h2><code>ActiveRecord</code>&rsquo;s <code>merge</code></h2>

<p>The <code>ActiveRecord</code>&rsquo;s <code>merge</code>, instead, helps to build queries that involve two
or more models that need to work with defined scopes. What it does is merging
scopes prior to perform the query.</p>

<p>Example:</p>

<p>Let&rsquo;s build two models, <code>Client</code> wihch has many <code>Product</code>s, each one with some
scopes.</p>
<pre class="highlight ruby"><code><span class="c1"># app/models/client.rb</span>
<span class="k">class</span> <span class="nc">Client</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:products</span>

  <span class="n">scope</span> <span class="ss">:recently_activated</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="s1">'activated_at &gt; ?'</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="nf">month</span><span class="p">.</span><span class="nf">ago</span> <span class="p">}</span>
<span class="k">end</span>

<span class="c1"># app/models/product.rb</span>
<span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:client</span>

  <span class="n">scope</span> <span class="ss">:expensive</span><span class="p">,</span>  <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="s1">'products.price &gt; 1000'</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:small</span><span class="p">,</span>      <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="s1">'products.size &lt;= 99'</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:medium</span><span class="p">,</span>     <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="s1">'products.size &gt; 99 AND products.size &lt; 999'</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:big</span><span class="p">,</span>        <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="s1">'products.size &gt;= 999'</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:available</span><span class="p">,</span>  <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">available: </span><span class="kp">true</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>

<p>Now, if you want to know all the recently activated clients who bought
expensive medium available products, you have to build your query this way:</p>
<pre class="highlight ruby"><code><span class="no">Client</span><span class="p">.</span><span class="nf">recently_activated</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:products</span><span class="p">).</span>
  <span class="nf">where</span><span class="p">(</span><span class="s1">'products.price &gt; 1000 AND products.size &gt; 99 AND products.size &lt; 999 AND products.available = ?'</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>
</code></pre>

<p>Or, using the <code>merge</code> method.</p>
<pre class="highlight ruby"><code><span class="no">Client</span><span class="p">.</span><span class="nf">recently_activated</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:products</span><span class="p">).</span><span class="nf">merge</span><span class="p">(</span><span class="no">Product</span><span class="p">.</span><span class="nf">expensive</span><span class="p">.</span><span class="nf">medium</span><span class="p">.</span><span class="nf">available</span><span class="p">)</span>
</code></pre>

<p>The last code is not only easier to build and easier to read, it also follows
better a DRY concept. If, for any reason, the definition of &lsquo;medium&rsquo; changes,
you only have to change it in one place, all your queries remain intact.</p>

<p>It is also possible to use <code>merge</code> inside a scope. Example:</p>
<pre class="highlight ruby"><code><span class="c1"># app/models/client.rb</span>
<span class="k">class</span> <span class="nc">Client</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:products</span>

  <span class="n">scope</span> <span class="ss">:recently_activated</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="s1">'activated_at &gt; ?'</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="nf">month</span><span class="p">.</span><span class="nf">ago</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:with_expensive_products</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">joins</span><span class="p">(</span><span class="ss">:products</span><span class="p">).</span><span class="nf">merge</span><span class="p">(</span><span class="no">Product</span><span class="p">.</span><span class="nf">expensive</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>

<p>Quite useful, right?</p>

  </article>

      </section>
      <footer>
  <div class="container">
    <ul class="large-column">
      <li><h5 class="heading">Recent Articles</h5></li>
      <li>
        <ol>
            <li>
              <a href="/2015/05/04/directory-tree.html">Directory tree</a>
              <span>May  4</span>
            </li>
            <li>
              <a href="/2015/04/13/directory-structure-conventions-in-rspec-and-minitest.html">Directory structure conventions in RSpec and Minitest</a>
              <span>Apr 13</span>
            </li>
            <li>
              <a href="/2015/01/12/joins-vs-includes-espanol.html">Joins vs Includes (Español)</a>
              <span>Jan 12</span>
            </li>
            <li>
              <a href="/2014/12/08/joins-vs-includes.html">Joins vs Includes</a>
              <span>Dec  8</span>
            </li>
            <li>
              <a href="/2014/09/01/minitest-v4-y-v5.html">Minitest v4 y  v5</a>
              <span>Sep  1</span>
            </li>
            <li>
              <a href="/2014/07/14/minitest-v4-and-v5.html">Minitest v4 and v5</a>
              <span>Jul 14</span>
            </li>
            <li>
              <a href="/2014/03/11/formularios-anidados.html">Formularios anidados</a>
              <span>Mar 11</span>
            </li>
            <li>
              <a href="/2014/02/10/como-solucionar-las-consultas-n-1-en-rails.html">Cómo solucionar consultas N+1 en Rails</a>
              <span>Feb 10</span>
            </li>
            <li>
              <a href="/2014/02/03/how-to-fix-n-1-queries-in-rails.html">How to fix N+1 queries in Rails</a>
              <span>Feb  3</span>
            </li>
            <li>
              <a href="/2014/01/13/super-in-ruby.html">Super in Ruby</a>
              <span>Jan 13</span>
            </li>
        </ol>
      </li>
    </ul>

    <ul class="small-column">
      <li><h5 class="heading">Tags</h5></li>
      <li>
        <ol>
            <li><a href="/tags/rails.html">Rails (8)</a></li>
            <li><a href="/tags/activerecord.html">ActiveRecord (7)</a></li>
            <li><a href="/tags/nested_attributes.html">nested_attributes (1)</a></li>
            <li><a href="/tags/formularios.html">formularios (1)</a></li>
            <li><a href="/tags/ruby.html">Ruby (5)</a></li>
            <li><a href="/tags/struct.html">Struct (1)</a></li>
            <li><a href="/tags/openstruct.html">OpenStruct (1)</a></li>
            <li><a href="/tags/asociaciones.html">Asociaciones (1)</a></li>
            <li><a href="/tags/minitest.html">Minitest (3)</a></li>
            <li><a href="/tags/rspec.html">RSpec (2)</a></li>
            <li><a href="/tags/tree.html">tree (1)</a></li>
        </ol>
      </li>
      <ul>
  </div>
</footer>

    </div>
  </body>
</html>
