<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <title>El Blog de ApuX - Joins vs Includes (Español)</title>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
    <link href="/stylesheets/all.css" rel="stylesheet" type="text/css" />
  </head>
  <body>
    <div id="main" role="main">
      <nav>
  <ul>
    <li>
<a class="blog-title" href="/">        El Blog de Ap<span>uX</span>
</a>      <span class="caption">My Learning about Software Development</span>
    </li>
  </ul>
</nav>

      <section id="content">
          <article>
    <h1 class="heading">
      Joins vs Includes (Español)
      <time>Jan 12 2015</time>
    </h1>
    <p>A veces, <code>includes</code> y <code>joins</code> pueden resultar confusos porque hay escenarios donde parecen ser intercambiables, pero hay razones específicas para usar uno o el otro.</p>

<h2><code>joins</code></h2>

<p><code>joins</code> nos permite especificar una relación a incluirse en la consulta. La consulta resultante incluirá una cláusula <code>JOIN</code> (SQL).</p>

<p>Digamos que tenemos estos dos modelos, Empleado (<code>Employee</code>) que tiene una Computadora (<code>Computer</code>).</p>
<pre class="highlight ruby"><code><span class="c1">#app/models/employee.rb</span>
<span class="k">class</span> <span class="nc">Employee</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_one</span> <span class="ss">:computer</span>
<span class="k">end</span>

<span class="c1">#app/models/computer.rb</span>
<span class="k">class</span> <span class="nc">Computer</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:employee</span>
<span class="k">end</span>
</code></pre>

<p>Si queremos conocer todos los empleados cuyo nombre sea Fernando y tengan una computadora Dell, podemos usar <code>joins</code>.</p>
<pre class="highlight ruby"><code><span class="no">Employee</span><span class="p">.</span>
  <span class="nf">joins</span><span class="p">(</span><span class="ss">:computer</span><span class="p">).</span>
  <span class="nf">where</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Fernando'</span><span class="p">,</span> <span class="ss">computers: </span><span class="p">{</span> <span class="ss">brand: </span><span class="s1">'Dell'</span> <span class="p">})</span>
</code></pre>

<p>Esta consulta funciona bien y regresa todos los empleados que cunmplan con las condiciones.</p>

<p>El SQL será algo como esto:</p>
<pre class="highlight sql"><code><span class="k">SELECT</span> <span class="nv">"employees"</span><span class="p">.</span><span class="o">*</span>
 <span class="k">FROM</span> <span class="nv">"employees"</span>
 <span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">"computers"</span> <span class="k">ON</span> <span class="nv">"computers"</span><span class="p">.</span><span class="nv">"employee_id"</span> <span class="o">=</span> <span class="nv">"employees"</span><span class="p">.</span><span class="nv">"id"</span>
 <span class="k">WHERE</span> <span class="nv">"employees"</span><span class="p">.</span><span class="nv">"name"</span> <span class="o">=</span> <span class="s1">'Fernando'</span> <span class="k">AND</span> <span class="nv">"computers"</span><span class="p">.</span><span class="nv">"brand"</span> <span class="o">=</span> <span class="s1">'Dell'</span>

</code></pre>

<h2><code>includes</code></h2>

<p>Como explicamos en <a href="/2014/02/10/como-solucionar-las-consultas-n-1-en-rails.html">un post previo</a>, si queremos cargar todos los empleados y todas sus computadoras en una única consulta, podemos usar <code>includes</code>, </p>
<pre class="highlight ruby"><code><span class="no">Employee</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:computer</span><span class="p">)</span>
</code></pre>

<p>De esta manera, Rails golpea la base de datos sólo una vez, y carga todos los datos de empleados y computadoras. Puede que la confusión empiece aquí, porque al usar <code>includes</code> podemos también realizar algunas condicionales en la cláusula <code>where</code>. Por ejemplo:</p>
<pre class="highlight ruby"><code><span class="no">Employee</span><span class="p">.</span>
  <span class="nf">includes</span><span class="p">(</span><span class="ss">:computer</span><span class="p">).</span>
  <span class="nf">where</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Fernando'</span><span class="p">,</span> <span class="ss">computers: </span><span class="p">{</span> <span class="ss">brand: </span><span class="s1">'Dell'</span> <span class="p">})</span>
</code></pre>

<p>Como podemos ver, es posible incluir condicionales que afecten ambas asociaciones, tal como lo hicimos con <code>joins</code>.</p>

<p>Sin embargo, el SQL resultante es diferente. Veamos:</p>
<pre class="highlight sql"><code><span class="k">SELECT</span> <span class="nv">"employees"</span><span class="p">.</span><span class="nv">"id"</span> <span class="k">AS</span> <span class="n">t0_r0</span><span class="p">,</span>
 <span class="nv">"employees"</span><span class="p">.</span><span class="nv">"name"</span> <span class="k">AS</span> <span class="n">t0_r1</span><span class="p">,</span>
 <span class="nv">"employees"</span><span class="p">.</span><span class="nv">"created_at"</span> <span class="k">AS</span> <span class="n">t0_r2</span><span class="p">,</span>
 <span class="nv">"employees"</span><span class="p">.</span><span class="nv">"updated_at"</span> <span class="k">AS</span> <span class="n">t0_r3</span><span class="p">,</span>
 <span class="nv">"computers"</span><span class="p">.</span><span class="nv">"id"</span> <span class="k">AS</span> <span class="n">t1_r0</span><span class="p">,</span>
 <span class="nv">"computers"</span><span class="p">.</span><span class="nv">"brand"</span> <span class="k">AS</span> <span class="n">t1_r1</span><span class="p">,</span>
 <span class="nv">"computers"</span><span class="p">.</span><span class="nv">"model"</span> <span class="k">AS</span> <span class="n">t1_r2</span><span class="p">,</span>
 <span class="nv">"computers"</span><span class="p">.</span><span class="nv">"employee_id"</span> <span class="k">AS</span> <span class="n">t1_r3</span><span class="p">,</span>
 <span class="nv">"computers"</span><span class="p">.</span><span class="nv">"created_at"</span> <span class="k">AS</span> <span class="n">t1_r4</span><span class="p">,</span>
 <span class="nv">"computers"</span><span class="p">.</span><span class="nv">"updated_at"</span> <span class="k">AS</span> <span class="n">t1_r5</span>
 <span class="k">FROM</span> <span class="nv">"employees"</span>
 <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="nv">"computers"</span> <span class="k">ON</span> <span class="nv">"computers"</span><span class="p">.</span><span class="nv">"employee_id"</span> <span class="o">=</span> <span class="nv">"employees"</span><span class="p">.</span><span class="nv">"id"</span>
 <span class="k">WHERE</span> <span class="nv">"employees"</span><span class="p">.</span><span class="nv">"name"</span> <span class="o">=</span> <span class="s1">'Fernando'</span> <span class="k">AND</span> <span class="nv">"computers"</span><span class="p">.</span><span class="nv">"brand"</span> <span class="o">=</span> <span class="s1">'Dell'</span>
</code></pre>

<p>Como vemos, <code>includes</code> agrega todos los campos de la computadora, como se espera, mientras que <code>joins</code> no lo hace. Y esa pequeña diferencia es la que debemos tenee en cuenta.</p>

<p>Cuando sólo queremos filtrar los resultado de una consulta basados en un campo que pertenece a una relación secundaria, pero no vamos a usar datos de esa relación más adelante, debemos usar <code>joins</code>. De otra forma, cargaremos muchos datos que no vamos a usar.</p>

<p>Ejemplo:</p>
<pre class="highlight ruby"><code><span class="n">employees</span> <span class="o">=</span> <span class="no">Employee</span><span class="p">.</span>
  <span class="nf">joins</span><span class="p">(</span><span class="ss">:computer</span><span class="p">).</span>
  <span class="nf">where</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Fernando'</span><span class="p">,</span> <span class="ss">computer: </span><span class="p">{</span> <span class="ss">brand: </span><span class="s1">'Dell'</span> <span class="p">})</span>
<span class="nb">puts</span> <span class="n">employees</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:name</span><span class="p">)</span>
</code></pre>

<p>En la otra mano, si necesitamos usar datos de la relación secundaria, entonces <code>includes</code> es obligatorio, de otra manera, tendremos poblemas de consultas N+1.</p>

<p>Ejemplo:</p>
<pre class="highlight ruby"><code><span class="n">employees</span> <span class="o">=</span> <span class="no">Employee</span><span class="p">.</span>
  <span class="nf">joins</span><span class="p">(</span><span class="ss">:computer</span><span class="p">).</span>
  <span class="nf">where</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Fernando'</span><span class="p">,</span> <span class="ss">computer: </span><span class="p">{</span> <span class="ss">brand: </span><span class="s1">'Dell'</span> <span class="p">})</span>
<span class="nb">puts</span> <span class="n">employees</span><span class="p">.</span><span class="nf">map</span><span class="p">{</span><span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="s2">"</span><span class="si">#{</span><span class="n">e</span><span class="p">.</span><span class="nf">full_name</span><span class="si">}</span><span class="s2"> has a Dell </span><span class="si">#{</span><span class="n">e</span><span class="p">.</span><span class="nf">computer</span><span class="p">.</span><span class="nf">model</span><span class="si">}</span><span class="s2">"</span> <span class="p">}</span>
</code></pre>

<p>No es tan confuso después de todo, ¿cierto?</p>

  </article>
  <div id="disqus_thread"></div>
<script type="text/javascript">
//<![CDATA[
                  var disqus_shortname = 'elblogdeapux';
          
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
//]]>
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


      </section>
      <footer>
  <div class="container">
    <ul class="large-column">
      <li><h5 class="heading">Recent Articles</h5></li>
      <li>
        <ol>
            <li>
              <a href="/2015/11/11/how-to-install-zsh.html">How to Install Zsh</a>
              <span>Nov 11</span>
            </li>
            <li>
              <a href="/2015/08/31/how-to-install-postgresql-in-chakra-linux.html">How to Install Postgresql in Chakra Linux</a>
              <span>Aug 31</span>
            </li>
            <li>
              <a href="/2015/07/20/using-vim-regexp-to-update-to-rspec3-syntax.html">Using Vim Regexp to Update to RSpec 3 Syntax</a>
              <span>Jul 20</span>
            </li>
            <li>
              <a href="/2015/05/04/directory-tree.html">Directory tree</a>
              <span>May  4</span>
            </li>
            <li>
              <a href="/2015/04/13/directory-structure-conventions-in-rspec-and-minitest.html">Directory structure conventions in RSpec and Minitest</a>
              <span>Apr 13</span>
            </li>
            <li>
              <a href="/2015/01/12/joins-vs-includes-espanol.html">Joins vs Includes (Español)</a>
              <span>Jan 12</span>
            </li>
            <li>
              <a href="/2014/12/08/joins-vs-includes.html">Joins vs Includes</a>
              <span>Dec  8</span>
            </li>
            <li>
              <a href="/2014/09/01/minitest-v4-y-v5.html">Minitest v4 y  v5</a>
              <span>Sep  1</span>
            </li>
            <li>
              <a href="/2014/07/14/minitest-v4-and-v5.html">Minitest v4 and v5</a>
              <span>Jul 14</span>
            </li>
            <li>
              <a href="/2014/03/11/formularios-anidados.html">Formularios anidados</a>
              <span>Mar 11</span>
            </li>
        </ol>
      </li>
    </ul>

    <ul class="small-column">
      <li><h5 class="heading">Tags</h5></li>
      <li>
        <ol>
            <li><a href="/tags/rails.html">Rails (8)</a></li>
            <li><a href="/tags/activerecord.html">ActiveRecord (7)</a></li>
            <li><a href="/tags/nested_attributes.html">nested_attributes (1)</a></li>
            <li><a href="/tags/formularios.html">formularios (1)</a></li>
            <li><a href="/tags/ruby.html">Ruby (5)</a></li>
            <li><a href="/tags/struct.html">Struct (1)</a></li>
            <li><a href="/tags/openstruct.html">OpenStruct (1)</a></li>
            <li><a href="/tags/asociaciones.html">Asociaciones (1)</a></li>
            <li><a href="/tags/minitest.html">Minitest (3)</a></li>
            <li><a href="/tags/postgresql.html">postgresql (1)</a></li>
            <li><a href="/tags/chakra.html">chakra (1)</a></li>
            <li><a href="/tags/vim.html">vim (1)</a></li>
            <li><a href="/tags/regexp.html">regexp (1)</a></li>
            <li><a href="/tags/rspec.html">rspec (1)</a></li>
            <li><a href="/tags/rspec.html">RSpec (2)</a></li>
            <li><a href="/tags/tree.html">tree (1)</a></li>
        </ol>
      </li>
      <ul>
  </div>
</footer>

    </div>
  </body>
</html>
